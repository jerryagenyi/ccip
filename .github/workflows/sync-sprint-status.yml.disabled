name: Sync Sprint Status to GitHub Projects

on:
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all items (ignores unchanged status)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  push:
    paths:
      - 'docs/sprint-artifacts/sprint-status.yaml'

jobs:
  sync:
    name: Sync sprint-status.yaml to GitHub Projects
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      project: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Get project data
        id: project-data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: jerryagenyi
          PROJECT_NUMBER: 2
        run: |
          # Get project ID and field IDs
          gh api graphql \
            -f query='
              query($user: String!, $number: Int!) {
                user(login: $user) {
                  projectV2(number: $number) {
                    id
                    title
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }' \
            -f user=$USER \
            -F number=$PROJECT_NUMBER > project_data.json
          
          # Extract IDs
          PROJECT_ID=$(jq -r '.data.user.projectV2.id' project_data.json)
          STATUS_FIELD_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .id' project_data.json)
          
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "STATUS_FIELD_ID=$STATUS_FIELD_ID" >> $GITHUB_OUTPUT
          
          # Extract status option IDs
          echo "BACKLOG_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="Backlog") | .id' project_data.json)" >> $GITHUB_OUTPUT
          echo "DRAFTED_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="Drafted") | .id' project_data.json)" >> $GITHUB_OUTPUT
          echo "READY_FOR_DEV_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="Ready for Dev") | .id' project_data.json)" >> $GITHUB_OUTPUT
          echo "IN_PROGRESS_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="In Progress") | .id' project_data.json)" >> $GITHUB_OUTPUT
          echo "REVIEW_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="Review") | .id' project_data.json)" >> $GITHUB_OUTPUT
          echo "DONE_OPTION_ID=$(jq -r '.data.user.projectV2.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="Done") | .id' project_data.json)" >> $GITHUB_OUTPUT

      - name: Read sprint-status.yaml
        id: sprint-status
        run: |
          python3 << 'EOF'
          import yaml
          import json
          import sys
          
          with open('docs/sprint-artifacts/sprint-status.yaml', 'r') as f:
              data = yaml.safe_load(f)
          
          status = data.get('development_status', {})
          
          # Convert to JSON for output
          print(json.dumps(status))
          EOF > sprint_status.json

      - name: Sync status to GitHub Projects
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_ID: ${{ steps.project-data.outputs.PROJECT_ID }}
          STATUS_FIELD_ID: ${{ steps.project-data.outputs.STATUS_FIELD_ID }}
          BACKLOG_OPTION_ID: ${{ steps.project-data.outputs.BACKLOG_OPTION_ID }}
          DRAFTED_OPTION_ID: ${{ steps.project-data.outputs.DRAFTED_OPTION_ID }}
          READY_FOR_DEV_OPTION_ID: ${{ steps.project-data.outputs.READY_FOR_DEV_OPTION_ID }}
          IN_PROGRESS_OPTION_ID: ${{ steps.project-data.outputs.IN_PROGRESS_OPTION_ID }}
          REVIEW_OPTION_ID: ${{ steps.project-data.outputs.REVIEW_OPTION_ID }}
          DONE_OPTION_ID: ${{ steps.project-data.outputs.DONE_OPTION_ID }}
        run: |
          python3 << 'EOF'
          import json
          import subprocess
          import os
          
          # Load sprint status
          with open('sprint_status.json', 'r') as f:
              status = json.load(f)
          
          # Status mapping
          STATUS_MAP = {
              'backlog': os.getenv('BACKLOG_OPTION_ID'),
              'drafted': os.getenv('DRAFTED_OPTION_ID'),
              'ready-for-dev': os.getenv('READY_FOR_DEV_OPTION_ID'),
              'in-progress': os.getenv('IN_PROGRESS_OPTION_ID'),
              'review': os.getenv('REVIEW_OPTION_ID'),
              'done': os.getenv('DONE_OPTION_ID'),
          }
          
          PROJECT_ID = os.getenv('PROJECT_ID')
          STATUS_FIELD_ID = os.getenv('STATUS_FIELD_ID')
          
          # Get all issues with story/epic labels
          result = subprocess.run(
              ['gh', 'issue', 'list', '--repo', 'jerryagenyi/ccip', 
               '--label', 'story,epic', '--json', 'number,title,labels'],
              capture_output=True,
              text=True
          )
          
          if result.returncode != 0:
              print(f"Error fetching issues: {result.stderr}")
              exit(1)
          
          issues = json.loads(result.stdout)
          
          # Create mapping from issue title/number to story/epic key
          issue_map = {}
          for issue in issues:
              # Extract story/epic identifier from title or labels
              for label in issue.get('labels', []):
                  if label['name'].startswith('epic:'):
                      epic_key = label['name'].replace('epic:', '')
                      issue_map[epic_key] = issue['number']
                  elif 'story' in [l['name'] for l in issue.get('labels', [])]:
                      # Try to extract US-XXX from title
                      title = issue['title']
                      if 'US-' in title:
                          story_key = title.split('US-')[1].split(':')[0].split('-')[0]
                          story_key = f"US-{story_key.zfill(3)}"
                          # Find matching key in status
                          for key in status.keys():
                              if key.startswith(story_key):
                                  issue_map[key] = issue['number']
                                  break
          
          # Get project items
          result = subprocess.run(
              ['gh', 'api', 'graphql', '-f', f'query=query($project: ID!) {{ node(id: $project) {{ ... on ProjectV2 {{ items(first: 100) {{ nodes {{ id content {{ ... on Issue {{ number title }} }} fieldValues(first: 10) {{ nodes {{ ... on ProjectV2ItemFieldSingleSelectValue {{ field {{ id name }} singleSelectOptionId }} }} }} }} }} }} }} }}', '-f', f'project={PROJECT_ID}'],
              capture_output=True,
              text=True
          )
          
          if result.returncode != 0:
              print(f"Error fetching project items: {result.stderr}")
              exit(1)
          
          project_data = json.loads(result.stdout)
          project_items = project_data.get('data', {}).get('node', {}).get('items', {}).get('nodes', [])
          
          # Create mapping from issue number to project item ID
          item_map = {}
          for item in project_items:
              issue_num = item.get('content', {}).get('number')
              if issue_num:
                  item_map[issue_num] = item['id']
          
          # Update project items
          updated_count = 0
          for key, yaml_status in status.items():
              if key.startswith('US-') or (key.startswith('epic-') and not key.endswith('-retrospective')):
                  issue_num = issue_map.get(key)
                  if not issue_num:
                      continue
                  
                  item_id = item_map.get(issue_num)
                  if not item_id:
                      continue
                  
                  status_option_id = STATUS_MAP.get(yaml_status)
                  if not status_option_id:
                      print(f"⚠️  Unknown status '{yaml_status}' for {key}")
                      continue
                  
                  # Update status field
                  result = subprocess.run(
                      ['gh', 'api', 'graphql', '-f', 
                       f'query=mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {{ updateProjectV2ItemFieldValue(input: {{ projectId: $project itemId: $item fieldId: $field value: {{ singleSelectOptionId: $value }} }}) {{ projectV2Item {{ id }} }} }}',
                       '-f', f'project={PROJECT_ID}',
                       '-f', f'item={item_id}',
                       '-f', f'field={STATUS_FIELD_ID}',
                       '-f', f'value={status_option_id}'],
                      capture_output=True,
                      text=True
                  )
                  
                  if result.returncode == 0:
                      updated_count += 1
                      print(f"✅ Updated {key} (Issue #{issue_num}) to status: {yaml_status}")
                  else:
                      print(f"❌ Failed to update {key}: {result.stderr}")
          
          print(f"\n✅ Synced {updated_count} items to GitHub Projects")
          EOF

      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Sprint status synced to GitHub Projects" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check your project: https://github.com/users/jerryagenyi/projects/2" >> $GITHUB_STEP_SUMMARY

