# Deploy Pipeline - Runs when code is merged to main
# Deploys to Hostinger VPS using Dokploy Docker Compose
#
# Dokploy auto-deploys on push to main when:
# 1. GitHub repository is connected
# 2. Auto-Deploy is enabled in Dokploy
# 3. Docker Compose application is configured

name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ============================================
  # Deployment Status Check
  # ============================================
  deploy-status:
    name: Deployment Status
    runs-on: ubuntu-latest

    steps:
      - name: Check Deployment
        run: |
          echo "‚úÖ Deployment triggered by push to main branch"
          echo "üìä Dokploy will auto-deploy from Docker Compose"
          echo "üîó Project: http://72.61.19.90:3000/dashboard/project/xzYEMcKghF7krrf2peEaI"
          echo "üåê Production URL: https://app.jerryagenyi.xyz"
          echo ""
          echo "Deployment progress can be monitored in Dokploy dashboard."
          echo "Typical deployment time: 2-5 minutes"

      - name: Health Check
        run: |
          # Wait for deployment to start
          sleep 30

          # Check if services are responding
          echo "Checking deployment health..."

          # Check frontend
          if curl -f https://app.jerryagenyi.xyz > /dev/null 2>&1; then
            echo "‚úÖ Frontend is responding"
          else
            echo "‚è≥ Frontend still starting..."
          fi

          # Check backend API
          if curl -f https://api.jerryagenyi.xyz/api/health > /dev/null 2>&1; then
            echo "‚úÖ Backend API is responding"
          else
            echo "‚è≥ Backend API still starting..."
          fi

          echo "Full deployment may take a few more minutes."
          echo "Monitor in Dokploy for detailed logs and status."

  # ============================================
  # Notification (Optional)
  # ============================================
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: deploy-status
    if: always()

    steps:
      - name: Deployment Complete
        run: |
          echo "üéâ Deployment to production initiated!"
          echo ""
          echo "What happened:"
          echo "- Code pushed to main branch"
          echo "- Dokploy detected the change"
          echo "- Docker Compose build started"
          echo "- Services will be updated with zero downtime"
          echo ""
          echo "Next steps:"
          echo "1. Monitor deployment in Dokploy dashboard"
          echo "2. Test the application at https://app.jerryagenyi.xyz"
          echo "3. Check backend API at https://api.jerryagenyi.xyz/api"
          echo ""
          echo "If deployment fails:"
          echo "- Check Docker Compose logs in Dokploy"
          echo "- Verify environment variables"
          echo "- Review build logs for errors"